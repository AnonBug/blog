# 传输层协议

## TCP 协议
> [两张动图-彻底明白TCP的三次握手与四次挥手](https://blog.csdn.net/qzcsu/article/details/72861891)
> [【深度讲解+面试回答】tcp/ip协议三次握手、四次挥手，通俗易懂，亲自解答 —— B站](https://www.bilibili.com/video/BV1bi4y1x7m5?from=search&seid=14824946240476707551)

TCP 是传输层的协议，提供面向连接的服务，在传输数据前必须先建立连接，数据传输后要释放连接，是一种**可靠**的传输服务。

在 TCP 中，**连接**作为最基本的对象，每条连接都有两个端点（套接字），断点定义为`IP 地址 + 端口号`。

### 三次握手
![三次握手](./imgs/handshake.png)

**细节理解**

1. 客户端发送 tcp 请求：`SYN 位` 置 1（表示请求建立连接），随机生成 `seq` = x 
2. 服务端响应 tcp 请求，`SYN 位` 仍为 1 ，随机生成 `seq` = y ，`ACK 位`置为 1， `ack` = x + 1
3. 客户端响应服务端的请求，`ACK 位`置为1， `seq` = x + 1 `，ack` = y + 1

> ack 表示确认字符

最终实现全双工通信，即同一时间信息可以双向传输。

**回答话术**

TCP/IP 协议是传输层的一个面向连接的安全可靠的一个传输协议，三次握手的机制是为了保证能建立一个安全可靠的连接，那么第一次握手是由客户端发起，客户端会向服务端发送一个报文，在报文里面：SYN标志位置为1，表示发起新的连接。当服务端收到这个报文之后就知道客户端要和我建立一个新的连接，于是服务端就向客户端发送一个确认消息包，在这个消息包里面：ack标志位置为1，表示确认客户端发起的第一次连接请求。以上两次握手之后，对于客户端而言：已经明确了我既能给服务端成功发消息，也能成功收到服务端的响应。但是对于服务端而言：两次握手是不够的，因为到目前为止，服务端只知道一件事，客户端发给我的消息我能收到，但是我响应给客户端的消息，客户端能不能收到我是不知道的。所以，还需要进行第三次握手，第三次握手就是当客户端收到服务端发送的确认响应报文之后，还要继续去给服务端进行回应，也是一个ack标志位置1的确认消息。通过以上三次连接，不管是客户端还是服务端，都知道我既能给对方发送消息，也能收到对方的响应。那么，这个连接就被安全的建了。

### 四次挥手
![四次挥手](./imgs/wave.png)

**技术细节**

1. 客户端发送报文， FIN 位 置1 ，表示请求断开连接，seq = x
2. 服务端确认消息， ACK 位 置1，ack = x + 1
3. 服务端发送结束报文， FIN 位置 1 ，seq = y
4. 客户端确认消息， ACK 位置1， ack = y + 1

为什么要四次挥手？

**回答话术**

四次握手机制也是由客户端去发起，客户端会发送一个报文，在报文里面FIN位标志位置一，当服务端收到这个报文之后，我就知道了客户端想要和我断开连接，但是此时服务端不一定能做好准备，因为当客户端发起断开连接的这个消息的时候，对于服务端而言，他和还有可能有未发送完的消息，他还要继续发送，所以呢，此时对于服务端而言，我只能进行一个消息确认，就是我先告诉服务端，我知道你要给我断开连接了，但是我这里边还可能没有做好准备，你需要等我一下，等会儿我会告诉你，于是呢，发完这个消息确认包之后，可能稍过片刻它就会继续发送一个断开连接的一个报文啊，也是一个FIN位置1的报文也是由服务端发给客户端的啊，这个报文表示服务端已经做好了断开连接的准备，那么当这个报文发给客户端的时候，客户端同样要给服务端继续发送一个消息确认的报文一共有四次，那么，通过这四次的相互沟通和连接，我就知道了，不管是服务端还是客户端都已经做好了断开连接的准备，于是连接就可以被断开啊，这是我对三次握手和四次挥手的一个理解。

为了防止回信丢失，客户端就再等2MSL个时间，之所以是2个，是因为涉及到来回，第一个MSL中是回信在路上的最大时间，第二个MSL是万一回信没到服务端，服务端重发的FIN确认在路上的时间（不知道这样理解对不对）。

### 拥塞控制

控制全局网络的拥塞情况，通过控制发送方每次发送的流量多少，逐渐试探整体网络的拥塞程度。
## UDP 协议
> [一文搞懂 TCP 与UDP 的区别](https://www.cnblogs.com/fundebug/p/differences-of-tcp-and-udp.html)

UDP （User Datagram Protocol，用户数据报协议）也是传输层的协议，是一种无连接的协议。当报文发送后，无法确认其是否安全到达。

UDP 不会对数据报文进行任何拆分与拼接操作，只会增加一个UDP头标识，就传递到网络层。接收端只需去除报文头就传递给应用层，不会进行任何拼接操作。UDP 具有一对多、多对一的方式。没有拥塞控制，可能导致丢包，适合某些实时性要求高的场景（如电话会议）等。

**与TCP 的特点对比**

| 特点| UDP| TCP |
--- | --- | ---
| 是否连接 | 否    | 是|
| 可靠性   | 否| 是|
| 传输方式 | 面向报文  | 面向字节流|
| 首部开销 | 8字节 | 20-60字节 |
| 传输速度 | 快| 慢   |
连接个数 | 1对1，1对多，多对1 | 1对1
| 适用场景 | 实时应用（电话会议、直播等） | 需要可靠传输的应用（文件传输等） |
